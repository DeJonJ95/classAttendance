<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Attendance Tracker (Live Backend)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .attendee-card {
            border: 1px solid #e2e8f0; padding: 12px; text-align: center;
            border-radius: 8px; font-size: 14px; font-weight: 500;
            transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
        }
        .attendee-card.not-present { background-color: #f1f5f9; color: #475569; border-color: #e2e8f0; }
        .attendee-card.present-attendant { background-color: #dbeafe; color: #1e40af; border-color: #93c5fd; }
        .attendee-card.present-balancer { background-color: #d1fae5; color: #065f46; border-color: #a7f3d0; }
        .attendee-card.present-cbs { background-color: #fee2e2; color: #991b1b; border-color: #fca5a5; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom-width: 1px; padding-bottom: 0.5rem; }
        .section-title { font-size: 1.25rem; font-weight: 600; color: #1f2937; }
        .section-counter { background-color: #e5e7eb; color: #374151; font-size: 0.875rem; font-weight: 600; padding: 0.25rem 0.75rem; border-radius: 9999px; }
        .loading-overlay { position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 50; text-align: center; padding: 1rem; }
        .loading-text { font-size: 1.25rem; font-semibold: 600; color: #1f2937; }
        .error-text { font-size: 1rem; color: #991b1b; margin-top: 0.5rem; max-width: 600px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="loading" class="loading-overlay">
        <p id="loading-text" class="loading-text">Connecting to Live Attendance...</p>
        <p id="error-text" class="error-text"></p>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Class Attendance</h1>
            <p class="text-gray-600 mt-2">Data is saved automatically and in real-time.</p>
        </header>

        <main>
            <!-- Form and Chart -->
            <div class="max-w-md mx-auto bg-white p-6 rounded-xl shadow-md mb-12">
                <form id="attendanceForm">
                    <div class="mb-4">
                        <label for="nameSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Your Name</label>
                        <select id="nameSelect" name="name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="">-- Please select your name --</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Your Role</label>
                        <select id="roleSelect" name="role" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="attendant">Attendant (Seated)</option>
                            <option value="balancer">Balancer</option>
                            <option value="cbs">CBS</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">
                        Sign In
                    </button>
                </form>
            </div>

            <div id="messageBox" class="hidden max-w-2xl mx-auto text-center p-4 mb-8 rounded-lg"></div>

            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                <div id="attendanceChart" class="space-y-8">
                    <div>
                        <div class="section-header"><h3 class="section-title">Not Yet Signed In</h3><span id="not-present-counter" class="section-counter">0</span></div>
                        <div id="not-present-section" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                    </div>
                    <div>
                        <div class="section-header"><h3 class="section-title">Attendants (Seated)</h3><span id="attendant-counter" class="section-counter">0</span></div>
                        <div id="attendant-section" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[60px]"></div>
                    </div>
                    <div>
                        <div class="section-header"><h3 class="section-title">Balancers</h3><span id="balancer-counter" class="section-counter">0</span></div>
                        <div id="balancer-section" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[60px]"></div>
                    </div>
                    <div>
                        <div class="section-header"><h3 class="section-title">CBS</h3><span id="cbs-counter" class="section-counter">0</span></div>
                        <div id="cbs-section" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[60px]"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAD5c35jwsWmo6OuQh6VXX1CclmWf4yDGQ",
            authDomain: "class-attendance-app-45e44.firebaseapp.com",
            projectId: "class-attendance-app-45e44",
            storageBucket: "class-attendance-app-45e44.firebasestorage.app",
            messagingSenderId: "138849480414",
            appId: "1:138849480414:web:3a6e8f7f3f731c613d5c4f",
            measurementId: "G-Y77K57MXH0"
        };


        const masterNameList = `
John Smith,Jane Doe,Peter Jones,Mary Johnson,Robert Brown,Patricia Garcia,
Michael Williams,Linda Davis,David Rodriguez,Jennifer Martinez,William Hernandez,Elizabeth Gonzalez,
James Wilson,Barbara Anderson,Charles Thomas,Susan Jackson,Joseph Taylor,Margaret Moore,
Richard White,Jessica Harris,Daniel Martin,Sarah Thompson,Thomas Anderson,Karen Clark,
Christopher Lewis,Nancy Robinson,Matthew Walker,Betty Hall,Donald Young,Helen Allen,
Anthony King,Sandra Wright,Mark Scott,Donna Green,Paul Adams,Carol Baker,
Steven Nelson,Kimberly Carter,Andrew Mitchell,Michelle Perez,Joshua Roberts,Laura Turner
`.trim().split(',').map(name => name.trim()).filter(name => name !== '').sort();

        let db, auth;
        let attendanceCollectionRef;
        let unsubscribe;

        const loadingText = document.getElementById('loading-text');
        const errorText = document.getElementById('error-text');
        
        async function setupFirebase() {
            try {
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    throw new Error("Firebase config not found or is incomplete. Please paste your configuration object into the 'firebaseConfig' variable in the script.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);

                const appId = firebaseConfig.appId || 'default-app-id';
                const today = new Date();
                const dateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                // This path is simplified but less secure for multi-app environments.
                // For this specific use case, it's acceptable.
                const attendancePath = `/attendance/${dateString}`; 
                attendanceCollectionRef = collection(db, attendancePath);

                listenForUpdates();
                
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingText.textContent = "Connection Failed";
                errorText.textContent = `Details: ${error.message}`;
            }
        }

        function renderChart(presentAttendees) {
            document.getElementById('not-present-section').innerHTML = '';
            document.getElementById('attendant-section').innerHTML = '';
            document.getElementById('balancer-section').innerHTML = '';
            document.getElementById('cbs-section').innerHTML = '';

            const presentNames = new Set(presentAttendees.map(p => p.name));
            masterNameList.forEach(name => {
                const id = name.replace(/\s+/g, '-');
                const presentAttendee = presentAttendees.find(p => p.name === name);
                const card = document.createElement('div');
                card.id = `card-${id}`;
                card.textContent = name;
                card.className = 'attendee-card';
                card.onclick = () => {
                    document.getElementById('nameSelect').value = name;
                    document.getElementById('roleSelect').focus();
                };
                if (presentAttendee) {
                    card.classList.add(`present-${presentAttendee.role}`);
                    document.getElementById(`${presentAttendee.role}-section`).appendChild(card);
                } else {
                    card.classList.add('not-present');
                    document.getElementById('not-present-section').appendChild(card);
                }
            });
            updateCounters();
        }

        function updateCounters() {
            document.getElementById('not-present-counter').textContent = document.getElementById('not-present-section').children.length;
            document.getElementById('attendant-counter').textContent = document.getElementById('attendant-section').children.length;
            document.getElementById('balancer-counter').textContent = document.getElementById('balancer-section').children.length;
            document.getElementById('cbs-counter').textContent = document.getElementById('cbs-section').children.length;
        }
        
        function populateForm() {
            const nameSelect = document.getElementById('nameSelect');
            masterNameList.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                nameSelect.appendChild(option);
            });
        }

        function showMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = `max-w-2xl mx-auto text-center p-4 mb-8 rounded-lg ${
                type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }`;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        function listenForUpdates() {
            if (unsubscribe) unsubscribe(); 
            unsubscribe = onSnapshot(attendanceCollectionRef, (snapshot) => {
                const presentAttendees = snapshot.docs.map(doc => doc.data());
                renderChart(presentAttendees);
                document.getElementById('loading').style.display = 'none';
            }, (error) => {
                console.error("Error listening to attendance updates:", error);
                loadingText.textContent = "Error Reading Data";
                errorText.textContent = `Please check your Firestore Security Rules. Details: ${error.message} (Code: ${error.code || 'N/A'})`;
            });
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const name = document.getElementById('nameSelect').value;
            const role = document.getElementById('roleSelect').value;
            if (!name) {
                showMessage('Please select your name.', 'error');
                return;
            }
            const attendeeData = { name: name, role: role, signInTime: serverTimestamp() };
            try {
                const docId = name.replace(/\s+/g, '-');
                await setDoc(doc(attendanceCollectionRef, docId), attendeeData);
                showMessage(`Welcome, ${name}! Your attendance is saved.`, 'success');
            } catch (error) {
                console.error("Error saving attendance:", error);
                showMessage(`Error: Could not save attendance. (${error.code})`, 'error');
            }
            document.getElementById('attendanceForm').reset();
            document.getElementById('nameSelect').value = '';
            document.getElementById('nameSelect').focus();
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateForm();
            setupFirebase();
            document.getElementById('attendanceForm').addEventListener('submit', handleFormSubmit);
        });
    </script>
</body>
</html>
